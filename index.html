<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videochamada Web com TraduÃ§Ã£o</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“º</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #36393f;
            color: #dcddde;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        .main-content {
            background-color: #2f3136;
            display: grid;
            grid-template-rows: 1fr auto;
            height: 100vh;
            overflow: hidden;
        }
        .video-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
            overflow-y: auto;
        }
        .video-wrapper {
            background-color: #202225;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        video {
            width: 100%;
            height: auto;
            transform: scaleX(-1);
        }
        .remote-video {
             transform: scaleX(1);
        }
        .video-wrapper p {
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.3);
            text-align: center;
            font-weight: bold;
        }
        .control-panel {
            background-color: #2f3136;
            padding: 1rem;
        }
        .chat-box {
            background-color: #40444b;
            border: none;
            height: 90px;
        }
        .btn { transition: background-color 0.3s; }
        .btn-mic-on { background-color: #3ba55d; }
        .btn-mic-off { background-color: #ed4245; }
        .btn-vid-on { background-color: #5865f2; }
        .btn-vid-off { background-color: #ed4245; }
    </style>
</head>
<body>
    <div class="main-content">
        <main id="video-grid" class="video-container"></main>
        <footer class="control-panel">
            <div class="flex items-center justify-center mb-4">
                <input id="share-link" type="text" class="bg-gray-700 text-white rounded-l p-2 w-full md:w-1/2" readonly>
                <button id="copy-link-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-2 rounded-r">Copiar Link</button>
            </div>
            <div id="chat-box" class="chat-box w-full p-2 mb-4 overflow-y-auto rounded-md">
                <p class="text-gray-400">Bem-vindo! As traduÃ§Ãµes aparecerÃ£o aqui.</p>
            </div>
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 md:gap-0">
                <div class="flex items-center space-x-4">
                    <button id="toggle-mic" class="btn btn-mic-on text-white font-bold py-2 px-4 rounded">Microfone</button>
                    <button id="toggle-video" class="btn btn-vid-on text-white font-bold py-2 px-4 rounded">VÃ­deo</button>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2 sm:space-x-2">
                    <label for="source-lang">Falar em:</label>
                    <select id="source-lang" class="bg-gray-700 text-white rounded p-2"></select>
                    <label for="dest-lang">Traduzir para:</label>
                    <select id="dest-lang" class="bg-gray-700 text-white rounded p-2"></select>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const videoGrid = document.getElementById('video-grid');
        const chatBox = document.getElementById('chat-box');
        const toggleMicBtn = document.getElementById('toggle-mic');
        const toggleVideoBtn = document.getElementById('toggle-video');
        const sourceLangSelect = document.getElementById('source-lang');
        const destLangSelect = document.getElementById('dest-lang');
        const shareLinkInput = document.getElementById('share-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');

        let localStream;
        const myUserId = 'user-' + Math.random().toString(36).substr(2, 9);
        let peerConnections = {};
        
        // CORREÃ‡ÃƒO: Extrai o ID da sala a partir do URL
        const roomId = window.location.pathname.split('/')[2];
        shareLinkInput.value = window.location.href;

        const wsProtocol = 'wss:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws`);

        const iceServers = { 'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }] };
        const synth = window.speechSynthesis;
        let availableVoices = [];
        let isAudioUnlocked = false;

        function loadVoices() {
            availableVoices = synth.getVoices();
        }

        function unlockAudio() {
            if (isAudioUnlocked) return;
            synth.speak(new SpeechSynthesisUtterance(""));
            isAudioUnlocked = true;
        }

        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideoStream(myUserId, localStream, true);
                setupUI();
                setupWebSocket();
                setupSpeechRecognition();
                loadVoices();
                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadVoices;
                }
            } catch (e) {
                console.error('Erro ao aceder Ã  mÃ­dia:', e);
                alert('NÃ£o foi possÃ­vel aceder Ã  cÃ¢mara e ao microfone.');
            }
        }

        function setupUI() {
            toggleMicBtn.addEventListener('click', () => { unlockAudio(); toggleMic(); });
            toggleVideoBtn.addEventListener('click', () => { unlockAudio(); toggleVideo(); });
            copyLinkBtn.addEventListener('click', () => {
                shareLinkInput.select();
                document.execCommand('copy');
                copyLinkBtn.textContent = 'Copiado!';
                setTimeout(() => { copyLinkBtn.textContent = 'Copiar Link'; }, 2000);
            });
            populateLanguageSelects();
        }

        function setupWebSocket() {
            ws.onopen = () => {
                console.log('Ligado ao servidor WebSocket');
                // CORREÃ‡ÃƒO: Envia o ID da sala e do utilizador ao entrar
                ws.send(JSON.stringify({ type: 'join', room_id: roomId, user_id: myUserId }));
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleSignalingData(data);
            };
            ws.onerror = (event) => {
                console.error("Erro no WebSocket:", event);
            }
        }

        function handleSignalingData(data) {
            switch (data.type) {
                // CORREÃ‡ÃƒO: Quando um novo utilizador entra, o cliente existente inicia a ligaÃ§Ã£o
                case 'user-joined':
                    console.log(`Novo utilizador ${data.user_id} entrou. A iniciar ligaÃ§Ã£o...`);
                    createPeerConnection(data.user_id, true);
                    break;
                case 'user-left':
                    removeVideoStream(data.user_id);
                    break;
                case 'offer': handleOffer(data); break;
                case 'answer': handleAnswer(data); break;
                case 'candidate': handleCandidate(data); break;
                case 'translation': displayTranslation(data); break;
            }
        }

        function createPeerConnection(targetId, isOfferor) {
            if (targetId === myUserId) return;
            console.log(`A criar PeerConnection para ${targetId}. Sou o iniciador: ${isOfferor}`);
            peerConnections[targetId] = new RTCPeerConnection(iceServers);
            localStream.getTracks().forEach(track => {
                peerConnections[targetId].addTrack(track, localStream);
            });
            peerConnections[targetId].ontrack = event => {
                addVideoStream(targetId, event.streams[0]);
            };
            peerConnections[targetId].onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, user_id: myUserId, target_id: targetId }));
                }
            };
            if (isOfferor) {
                peerConnections[targetId].createOffer()
                    .then(offer => peerConnections[targetId].setLocalDescription(offer))
                    .then(() => {
                        ws.send(JSON.stringify({ type: 'offer', offer: peerConnections[targetId].localDescription, user_id: myUserId, target_id: targetId }));
                    });
            }
        }
        
        async function handleOffer(data) {
            const peerId = data.user_id;
            console.log(`A receber oferta de ${peerId}`);
            createPeerConnection(peerId, false); // Cria a conexÃ£o como nÃ£o-iniciador
            await peerConnections[peerId].setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await peerConnections[peerId].createAnswer();
            await peerConnections[peerId].setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'answer', answer: peerConnections[peerId].localDescription, user_id: myUserId, target_id: peerId }));
        }

        async function handleAnswer(data) {
            console.log(`A receber resposta de ${data.user_id}`);
            await peerConnections[data.user_id].setRemoteDescription(new RTCSessionDescription(data.answer));
        }

        async function handleCandidate(data) {
            await peerConnections[data.user_id].addIceCandidate(new RTCIceCandidate(data.candidate));
        }

        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return;
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = sourceLangSelect.value;
            recognition.onresult = (event) => {
                const text = event.results[event.results.length - 1][0].transcript.trim();
                if (text) {
                    ws.send(JSON.stringify({ type: 'translate', text: text, user_id: myUserId, source_lang: sourceLangSelect.value, dest_lang: destLangSelect.value }));
                }
            };
            recognition.onend = () => {
                if (localStream.getAudioTracks()[0].enabled) {
                    recognition.start();
                }
            };
            recognition.start();
            sourceLangSelect.onchange = () => { recognition.lang = sourceLangSelect.value; };
        }

        function addVideoStream(userId, stream, isLocal = false) {
            if (document.getElementById('video-' + userId)) return;
            const videoWrapper = document.createElement('div');
            videoWrapper.id = 'video-' + userId;
            videoWrapper.className = 'video-wrapper';
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.muted = isLocal;
            if (!isLocal) video.classList.add('remote-video');
            const nameTag = document.createElement('p');
            nameTag.textContent = isLocal ? 'VocÃª' : userId;
            videoWrapper.appendChild(video);
            videoWrapper.appendChild(nameTag);
            videoGrid.appendChild(videoWrapper);
        }

        function removeVideoStream(userId) {
            const videoElement = document.getElementById('video-' + userId);
            if (videoElement) videoElement.remove();
            if (peerConnections[userId]) {
                peerConnections[userId].close();
                delete peerConnections[userId];
            }
        }

        function toggleMic() {
            const enabled = !localStream.getAudioTracks()[0].enabled;
            localStream.getAudioTracks()[0].enabled = enabled;
            toggleMicBtn.classList.toggle('btn-mic-on', enabled);
            toggleMicBtn.classList.toggle('btn-mic-off', !enabled);
        }

        function toggleVideo() {
            const enabled = !localStream.getVideoTracks()[0].enabled;
            localStream.getVideoTracks()[0].enabled = enabled;
            toggleVideoBtn.classList.toggle('btn-vid-on', enabled);
            toggleVideoBtn.classList.toggle('btn-vid-off', !enabled);
        }
        
        function displayTranslation(data) {
            const messageEl = document.createElement('p');
            messageEl.innerHTML = `<strong>${data.user_id === myUserId ? 'VocÃª' : data.user_id}:</strong> ${data.original} <em class="text-gray-300">(${data.translated})</em>`;
            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight;

            if (data.user_id === myUserId) return;
            
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(data.translated);
            const targetLang = destLangSelect.value;
            const selectedVoice = availableVoices.find(voice => voice.lang === targetLang);
            utterance.voice = selectedVoice || null;
            if (!selectedVoice) utterance.lang = targetLang;
            synth.speak(utterance);
        }

        function populateLanguageSelects() {
            const languages = {
                'pt-BR': 'PortuguÃªs (Brasil)', 'en-US': 'InglÃªs (EUA)', 'es-ES': 'Espanhol',
                'fr-FR': 'FrancÃªs', 'de-DE': 'AlemÃ£o', 'it-IT': 'Italiano', 'ja-JP': 'JaponÃªs',
            };
            for (const [code, name] of Object.entries(languages)) {
                sourceLangSelect.options.add(new Option(name, code));
                destLangSelect.options.add(new Option(name, code));
            }
            sourceLangSelect.value = 'pt-BR';
            destLangSelect.value = 'en-US';
        }

        init();
    </script>
</body>
</html>
