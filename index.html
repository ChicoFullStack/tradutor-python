<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Videoconfer√™ncia com Servidor Python</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -ms-overflow-style: none; scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }
        .video-player-container { 
            position: relative; 
            background-color: #2d3748; 
            border-radius: 0.5rem; 
            overflow: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            aspect-ratio: 16 / 9;
        }
        .video-player { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .remote-video { transform: scaleX(1); }
        .video-player.no-mirror {
            transform: scaleX(1);
            object-fit: contain;
        }
        .participant-name { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            background-color: rgba(0, 0, 0, 0.5); 
            padding: 0.25rem 0.75rem; 
            border-top-right-radius: 0.5rem; 
            font-size: 0.875rem; 
            transition: all 0.3s ease-in-out;
        }
        .thumbnail {
            width: 100%;
            flex-shrink: 0;
        }
        .thumbnail .participant-name {
            font-size: 0.7rem;
            padding: 1px 4px;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .mute-indicator, .hand-raised-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            padding: 0.5rem;
            display: none;
        }
        .video-player-container.muted .mute-indicator {
            display: flex;
        }
        #chat-panel, #participants-panel, #whiteboard-panel {
            transition: transform 0.3s ease-in-out;
        }
        @keyframes blinking {
            0% { color: white; }
            50% { color: #3b82f6; }
            100% { color: white; }
        }
        .blinking-icon {
            animation: blinking 1.5s infinite;
        }
        @keyframes float-up {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
        .floating-emoji {
            position: absolute;
            bottom: 3rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: float-up 2s ease-out forwards;
            pointer-events: none;
        }
        #whiteboard-canvas {
            cursor: crosshair;
            touch-action: none;
        }
        .connection-status-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: #cbd5e1;
            text-transform: capitalize;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen overflow-hidden">

    <div id="entry-modal" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div id="lobby-view" class="bg-gray-800 p-8 rounded-lg shadow-xl text-center w-full max-w-md"></div>
    </div>

    <header class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-700">
        <div class="flex items-center space-x-2 w-1/3">
            <i class="fas fa-video text-blue-400 text-xl"></i>
            <span class="text-lg font-semibold">ConnectSphere</span>
        </div>

        <div class="flex items-center justify-center space-x-2">
            <button id="mic-btn" title="Desativar o som" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i id="mic-on-icon" class="fas fa-microphone w-6 h-6"></i><i id="mic-off-icon" class="fas fa-microphone-slash w-6 h-6 hidden"></i></button>
            <button id="video-btn" title="Parar v√≠deo" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i id="video-on-icon" class="fas fa-video w-6 h-6"></i><i id="video-off-icon" class="fas fa-video-slash w-6 h-6 hidden"></i></button>
            <button id="screen-share-btn" title="Compartilhar tela" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-desktop w-6 h-6"></i></button>
            <div class="relative group">
                <button id="reactions-btn" title="Reagir" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-smile w-6 h-6"></i></button>
                <div id="emoji-palette" class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 bg-gray-600 rounded-full p-2 flex space-x-2 hidden group-hover:flex">
                    <span class="emoji-reaction cursor-pointer text-2xl">üëç</span>
                    <span class="emoji-reaction cursor-pointer text-2xl">‚ù§Ô∏è</span>
                    <span class="emoji-reaction cursor-pointer text-2xl">üòÇ</span>
                    <span class="emoji-reaction cursor-pointer text-2xl">üéâ</span>
                    <span class="emoji-reaction cursor-pointer text-2xl">üëè</span>
                </div>
            </div>
            <button id="participants-btn" title="Ver participantes" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-users w-6 h-6"></i></button>
            <button id="chat-btn" title="Abrir chat" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-comments w-6 h-6"></i></button>
            <button id="whiteboard-btn" title="Abrir quadro branco" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-chalkboard w-6 h-6"></i></button>
            <button id="file-share-btn" title="Partilhar ficheiro" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-paperclip w-6 h-6"></i></button>
            <button id="downloads-btn" title="Ver ficheiros recebidos" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-3"><i class="fas fa-download w-6 h-6"></i></button>
            <div class="w-px h-6 bg-gray-600 mx-2"></div>
            <button id="leave-btn" title="Sair da chamada" class="bg-red-600 hover:bg-red-700 transition-colors rounded-full p-3 px-4"><i class="fas fa-phone-slash w-6 h-6"></i></button>
        </div>

        <div class="flex items-center justify-end space-x-6 text-gray-400 w-1/3">
            <span id="room-name-display" class="text-sm text-gray-400"></span>
            <button id="copy-link-btn" title="Copiar link do convite" class="control-btn bg-gray-700 hover:bg-gray-600 transition-colors rounded-full p-2 hidden"><i class="fas fa-link w-6 h-6"></i></button>
            <i id="connection-status" class="fas fa-circle text-red-500" title="Desconectado"></i>
        </div>
    </header>
    
    <main id="video-grid" class="flex-grow p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto"></main>
    
    <input type="file" id="file-input" class="hidden" />
    <div id="file-transfer-panel" class="fixed bottom-4 right-4 w-80 space-y-2 z-30"></div>
    <div id="downloads-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-semibold">Ficheiros Recebidos</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div id="downloads-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <div id="chat-panel" class="fixed top-0 right-0 h-full w-80 bg-gray-800 shadow-lg z-50 transform translate-x-full flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <h3 class="text-xl font-semibold">Chat da Reuni√£o</h3>
            <button id="close-chat-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto"></div>
        <form id="chat-form" class="p-4 border-t border-gray-700 flex items-center">
            <input type="text" id="chat-input" class="w-full bg-gray-700 rounded-l-md p-2 focus:outline-none" placeholder="Escreva uma mensagem...">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 rounded-r-md p-2 px-4"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div id="participants-panel" class="fixed top-0 right-0 h-full w-80 bg-gray-800 shadow-lg z-50 transform translate-x-full flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <h3 class="text-xl font-semibold">Participantes</h3>
            <button id="close-participants-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
        </div>
        <div id="participants-list" class="flex-grow p-4 space-y-3 overflow-y-auto"></div>
        <div class="p-4 border-t border-gray-700">
            <button id="raise-hand-btn" class="w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                <i class="fas fa-hand-paper mr-2"></i>
                <span id="raise-hand-text">Levantar a M√£o</span>
            </button>
        </div>
    </div>
    
    <div id="whiteboard-panel" class="fixed inset-0 bg-gray-800 bg-opacity-95 z-40 hidden flex-col">
        <div id="whiteboard-toolbar" class="flex-shrink-0 p-2 bg-gray-900 flex items-center justify-center space-x-4">
            <div class="flex items-center space-x-2">
                <span>Cor:</span>
                <input type="color" id="color-picker" value="#FFFFFF">
            </div>
            <button id="clear-whiteboard-btn" class="px-3 py-1 bg-red-600 rounded">Limpar Tudo</button>
            <button id="close-whiteboard-btn" class="absolute top-2 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
        </div>
        <div class="flex-grow w-full h-full p-4">
            <canvas id="whiteboard-canvas"></canvas>
        </div>
    </div>


    <script>
        let localUserName = '';
        let roomName = '';
        let localStream = null;
        let screenStream = null;
        let isScreenSharing = false;
        let isHandRaised = false;
        let pinnedUserId = null;
        let ws = null;
        const peers = {};
        const fileBuffers = {};
        const receivedFiles = [];
        
        let isDrawing = false;
        let whiteboardCtx;
        let lastX = 0;
        let lastY = 0;
        let drawColor = '#FFFFFF';

        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
            ]
        };

        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
            }
        }

        function handleDataChannelMessage(event, senderId) {
            try {
                const message = JSON.parse(event.data);
                if (message.type === 'metadata') {
                    fileBuffers[message.name] = { chunks: [], receivedSize: 0, metadata: message };
                    showFileNotification(`A receber ${message.name}...`, message.name);
                    document.getElementById('downloads-btn').classList.add('blinking-icon');
                } else if (message.type === 'chat') {
                    displayChatMessage(message.content, senderId, false);
                } else if (message.type === 'name') {
                    if (peers[senderId]) {
                        peers[senderId].name = message.name;
                        updateParticipantList();
                    }
                } else if (message.type === 'raise_hand') {
                    if (peers[senderId]) {
                        peers[senderId].handRaised = message.raised;
                        updateParticipantList();
                    }
                } else if (message.type === 'emoji_reaction') {
                    displayEmojiOnVideo(senderId, message.emoji);
                } else if (message.type === 'whiteboard') {
                    handleWhiteboardDraw(message.data);
                } else if (message.type === 'whiteboard_state') {
                    setWhiteboardState(message.state === 'open');
                }
            } catch (e) {
                const fileInfo = Object.values(fileBuffers).find(f => !f.blob);
                if (fileInfo) {
                    fileInfo.chunks.push(event.data);
                    fileInfo.receivedSize += event.data.byteLength;
                    const progress = Math.round((fileInfo.receivedSize / fileInfo.metadata.size) * 100);
                    updateFileProgress(fileInfo.metadata.name, progress);
                    if (fileInfo.receivedSize === fileInfo.metadata.size) {
                        const fileBlob = new Blob(fileInfo.chunks);
                        fileInfo.blob = fileBlob;
                        showDownloadLink(fileInfo);
                    }
                }
            }
        }

        function sendFile(file) {
            const chunkSize = 16384;
            const reader = new FileReader();
            let offset = 0;
            const metadata = { type: 'metadata', name: file.name, size: file.size, fileType: file.type };
            
            for (const peerId in peers) {
                if (peers[peerId].dataChannel && peers[peerId].dataChannel.readyState === 'open') {
                    peers[peerId].dataChannel.send(JSON.stringify(metadata));
                }
            }
            showFileNotification(`A enviar ${file.name}...`, file.name);

            reader.onload = (e) => {
                const chunk = e.target.result;
                for (const peerId in peers) {
                    if (peers[peerId].dataChannel && peers[peerId].dataChannel.readyState === 'open') {
                        peers[peerId].dataChannel.send(chunk);
                    }
                }
                offset += chunk.byteLength;
                const progress = Math.round((offset / file.size) * 100);
                updateFileProgress(file.name, progress);
                if (offset < file.size) {
                    readSlice(offset);
                } else {
                     updateFileProgress(file.name, 100, true);
                }
            };
            const readSlice = o => {
                const slice = file.slice(offset, o + chunkSize);
                reader.readAsArrayBuffer(slice);
            };
            readSlice(0);
        }
        
        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            if (message) {
                displayChatMessage(message, 'local', true);
                for (const peerId in peers) {
                    if (peers[peerId].dataChannel && peers[peerId].dataChannel.readyState === 'open') {
                        peers[peerId].dataChannel.send(JSON.stringify({ type: 'chat', content: message }));
                    }
                }
                chatInput.value = '';
            }
        }

        function displayChatMessage(message, senderId, isLocal) {
            const chatMessages = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = `flex flex-col ${isLocal ? 'items-end' : 'items-start'}`;
            
            const senderName = isLocal ? localUserName : (peers[senderId]?.name || `Remoto ${senderId.substring(0, 6)}`);
            
            messageElement.innerHTML = `
                <span class="text-xs text-gray-400 mb-1">${senderName}</span>
                <div class="p-2 rounded-lg ${isLocal ? 'bg-blue-600' : 'bg-gray-600'}">
                    ${message}
                </div>
            `;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const chatPanel = document.getElementById('chat-panel');
            if (!isLocal && chatPanel.classList.contains('translate-x-full')) {
                document.getElementById('chat-btn').classList.add('blinking-icon');
            }
        }

        function displayEmojiOnVideo(userId, emoji) {
            const container = document.getElementById(`container-${userId}`);
            if (container) {
                const emojiElement = document.createElement('span');
                emojiElement.className = 'floating-emoji';
                emojiElement.innerText = emoji;
                container.appendChild(emojiElement);
                setTimeout(() => {
                    emojiElement.remove();
                }, 2000);
            }
        }

        function sendEmojiReaction(emoji) {
            displayEmojiOnVideo('local', emoji);
            for (const peerId in peers) {
                if (peers[peerId].dataChannel && peers[peerId].dataChannel.readyState === 'open') {
                    peers[peerId].dataChannel.send(JSON.stringify({ type: 'emoji_reaction', emoji: emoji }));
                }
            }
        }

        function showFileNotification(text, id) {
            const panel = document.getElementById('file-transfer-panel');
            let notification = document.getElementById(`file-${id}`);
            if (!notification) {
                notification = document.createElement('div');
                notification.id = `file-${id}`;
                notification.className = 'bg-gray-700 p-3 rounded-lg shadow-lg text-sm transition-opacity duration-500';
                panel.appendChild(notification);
            }
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span class="truncate">${text}</span>
                    <div class="w-16 text-right" id="progress-${id}">0%</div>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1">
                    <div id="bar-${id}" class="bg-blue-500 h-1.5 rounded-full" style="width: 0%"></div>
                </div>
            `;
        }

        function hideNotification(notificationId, delay) {
            setTimeout(() => {
                const notification = document.getElementById(notificationId);
                if (notification) {
                    notification.classList.add('opacity-0');
                    setTimeout(() => notification.remove(), 500); 
                }
            }, delay);
        }

        function updateFileProgress(id, progress, finished = false) {
            const progressBar = document.getElementById(`bar-${id}`);
            const progressText = document.getElementById(`progress-${id}`);
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressText) progressText.innerText = finished ? 'Conclu√≠do' : `${progress}%`;
            
            if (finished) {
                hideNotification(`file-${id}`, 5000);
            }
        }
        
        function showDownloadLink(fileInfo) {
            const url = URL.createObjectURL(fileInfo.blob);
            receivedFiles.push({ name: fileInfo.metadata.name, url: url });
            const notification = document.getElementById(`file-${fileInfo.metadata.name}`);
            if (notification) {
                notification.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="truncate">Recebeu ${fileInfo.metadata.name}</span>
                        <a href="${url}" download="${fileInfo.metadata.name}" class="ml-2 px-2 py-1 bg-green-500 rounded text-xs">Descarregar</a>
                    </div>`;
                hideNotification(notification.id, 15000);
            }
        }

        function createPeerConnection(targetId) {
            const pc = new RTCPeerConnection(configuration);
            
            peers[targetId] = {
                pc: pc,
                iceCandidates: [],
                name: `Remoto ${targetId.substring(0, 6)}`,
                muted: false,
                handRaised: false
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendMessage({ type: 'ice-candidate', candidate: event.candidate, target: targetId });
                }
            };

            pc.onconnectionstatechange = () => {
                const state = pc.connectionState;
                const container = document.getElementById(`container-${targetId}`);
                if (container) {
                    const statusDiv = container.querySelector('.connection-status-overlay');
                    if (statusDiv) {
                        statusDiv.textContent = state;
                        if (state === 'connected') {
                            statusDiv.classList.add('hidden');
                        } else {
                            statusDiv.classList.remove('hidden');
                        }
                    }
                }
            };

            pc.ontrack = (event) => {
                createPlayerContainer(targetId, event.streams[0]);
            };
            
            pc.ondatachannel = (event) => {
                const dataChannel = event.channel;
                dataChannel.onmessage = (e) => handleDataChannelMessage(e, targetId);
                peers[targetId].dataChannel = dataChannel;
            };

            const dataChannel = pc.createDataChannel('main');
            dataChannel.onopen = () => {
                dataChannel.send(JSON.stringify({ type: 'name', name: localUserName }));
            };
            dataChannel.onmessage = (e) => handleDataChannelMessage(e, targetId);
            
            peers[targetId].dataChannel = dataChannel;
            
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                });
            }

            return pc;
        }

        async function handleWebSocketMessages(message) {
            const data = JSON.parse(message.data);
            const senderId = data.sender;
            let pc;

            switch (data.type) {
                case 'all_users':
                    for (const userId of data.users) {
                        pc = createPeerConnection(userId);
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        sendMessage({ type: 'offer', offer: pc.localDescription, target: userId });
                    }
                    updateParticipantList();
                    break;
                case 'user_joined':
                    updateParticipantList();
                    break;
                case 'offer':
                    pc = createPeerConnection(senderId);
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    sendMessage({ type: 'answer', answer: pc.localDescription, target: senderId });
                    break;
                case 'answer':
                    pc = peers[senderId]?.pc;
                    if (pc) {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        peers[senderId].iceCandidates.forEach(candidate => {
                            pc.addIceCandidate(new RTCIceCandidate(candidate));
                        });
                        peers[senderId].iceCandidates = [];
                    }
                    break;
                case 'ice-candidate':
                    pc = peers[senderId]?.pc;
                    if (pc) {
                        if (pc.remoteDescription) {
                            await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        } else {
                            peers[senderId].iceCandidates.push(data.candidate);
                        }
                    }
                    break;
                case 'mute_status':
                    if (peers[senderId]) {
                        peers[senderId].muted = data.muted;
                        updateParticipantList();
                    }
                    break;
                case 'user_left':
                    if (peers[data.user_id]) {
                        peers[data.user_id].pc.close();
                        delete peers[data.user_id];
                    }
                    const videoContainer = document.getElementById(`container-${data.user_id}`);
                    if (videoContainer) videoContainer.remove();
                    updateParticipantList();
                    break;
            }
        }

        async function start(room) {
            roomName = room;
            document.getElementById('room-name-display').innerText = `Sala: ${roomName}`;
            document.getElementById('copy-link-btn').classList.remove('hidden');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                createPlayerContainer('local', localStream, localUserName);
                updateParticipantList();
            } catch (e) {
                alert(`N√£o foi poss√≠vel obter acesso √† c√¢mera e microfone: ${e.name}`);
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${roomName}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById('connection-status').classList.replace('text-red-500', 'text-green-500');
                document.getElementById('connection-status').title = 'Conectado';
            };
            ws.onmessage = handleWebSocketMessages;
            ws.onclose = () => {
                document.getElementById('connection-status').classList.replace('text-green-500', 'text-red-500');
                document.getElementById('connection-status').title = 'Desconectado';
            };
            ws.onerror = (err) => console.error("Erro no WebSocket:", err);
        }

        function pinParticipant(userIdToPin) {
            if (isScreenSharing) return;

            const videoGrid = document.getElementById('video-grid');
            const allContainers = Array.from(document.querySelectorAll('.video-player-container'));

            if (pinnedUserId === userIdToPin) {
                pinnedUserId = null;
                videoGrid.innerHTML = '';
                videoGrid.className = 'flex-grow p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto';
                allContainers.forEach(container => {
                    container.classList.remove('thumbnail');
                    videoGrid.appendChild(container);
                });
                return;
            }

            pinnedUserId = userIdToPin;
            const pinnedContainer = document.getElementById(`container-${userIdToPin}`);
            const remoteContainers = allContainers.filter(c => c.id !== `container-${userIdToPin}`);

            videoGrid.innerHTML = '';
            videoGrid.className = 'flex-grow flex flex-row p-4 gap-4';

            const mainStage = document.createElement('div');
            mainStage.className = 'flex-grow h-full';
            pinnedContainer.classList.remove('thumbnail');
            mainStage.appendChild(pinnedContainer);

            const thumbnailBar = document.createElement('div');
            thumbnailBar.className = 'w-1/4 lg:w-1/5 flex-shrink-0 flex flex-col gap-4 overflow-y-auto';
            
            remoteContainers.forEach(container => {
                container.classList.add('thumbnail');
                thumbnailBar.appendChild(container);
            });
            
            videoGrid.appendChild(mainStage);
            videoGrid.appendChild(thumbnailBar);
        }

        async function toggleScreenShare() {
            const screenShareBtn = document.getElementById('screen-share-btn');
            const videoGrid = document.getElementById('video-grid');
            const localContainer = document.getElementById('container-local');

            if (pinnedUserId) {
                pinParticipant(pinnedUserId); 
            }

            if (!isScreenSharing) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    
                    const remoteContainers = Array.from(document.querySelectorAll('.video-player-container:not(#container-local)'));
                    videoGrid.innerHTML = '';
                    videoGrid.className = 'flex-grow flex flex-row p-4 gap-4';

                    const mainStage = document.createElement('div');
                    mainStage.className = 'flex-grow h-full';
                    mainStage.appendChild(localContainer);
                    
                    const thumbnailBar = document.createElement('div');
                    thumbnailBar.id = 'thumbnail-bar';
                    thumbnailBar.className = 'w-1/4 lg:w-1/5 flex-shrink-0 flex flex-col gap-4 overflow-y-auto';
                    
                    remoteContainers.forEach(container => {
                        container.classList.add('thumbnail');
                        thumbnailBar.appendChild(container);
                    });

                    videoGrid.appendChild(mainStage);
                    videoGrid.appendChild(thumbnailBar);
                    
                    for (const peerId in peers) {
                        const sender = peers[peerId].pc.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) await sender.replaceTrack(screenTrack);
                    }

                    const localVideo = document.querySelector('#container-local video');
                    localVideo.srcObject = screenStream;
                    localVideo.classList.add('no-mirror');
                    isScreenSharing = true;
                    screenShareBtn.classList.replace('bg-gray-700', 'bg-blue-500');

                    screenTrack.onended = () => { if (isScreenSharing) toggleScreenShare(); };
                } catch (err) {
                    console.error("Erro ao iniciar a partilha de ecr√£:", err);
                    if (err.name === 'NotAllowedError') {
                        alert('A permiss√£o para partilhar o ecr√£ foi negada. Verifique as permiss√µes do seu navegador. Se estiver num iframe, a pol√≠tica de seguran√ßa pode estar a bloquear esta funcionalidade.');
                    } else {
                        alert('Ocorreu um erro desconhecido ao tentar iniciar a partilha de ecr√£.');
                    }
                }
            } else {
                const cameraTrack = localStream.getVideoTracks()[0];
                const remoteContainers = Array.from(document.querySelectorAll('#thumbnail-bar .video-player-container'));

                videoGrid.innerHTML = '';
                videoGrid.className = 'flex-grow p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto';
                
                localContainer.classList.remove('thumbnail');
                videoGrid.appendChild(localContainer);
                
                remoteContainers.forEach(container => {
                    container.classList.remove('thumbnail');
                    videoGrid.appendChild(container);
                });

                for (const peerId in peers) {
                    const sender = peers[peerId].pc.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) await sender.replaceTrack(cameraTrack);
                }

                if (screenStream) screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
                isScreenSharing = false;

                const localVideo = document.querySelector('#container-local video');
                localVideo.srcObject = localStream;
                localVideo.classList.remove('no-mirror');
                screenShareBtn.classList.replace('bg-blue-500', 'bg-gray-700');
            }
        }

        function createPlayerContainer(id, stream, name = `Remoto ${id.substring(0, 6)}`) {
            const videoGrid = document.getElementById('video-grid');
            const containerId = `container-${id}`;
            if (document.getElementById(containerId)) return;

            const container = document.createElement('div');
            container.id = containerId;
            container.className = 'video-player-container';
            container.onclick = () => pinParticipant(id);
            
            const videoElement = document.createElement('video');
            videoElement.srcObject = stream;
            videoElement.autoplay = true;
            videoElement.playsInline = true;
            videoElement.muted = (id === 'local');
            videoElement.className = `video-player ${id !== 'local' ? 'remote-video' : ''}`;
            
            const nameElement = document.createElement('div');
            nameElement.className = 'participant-name';
            nameElement.innerText = name;

            const muteIndicator = document.createElement('div');
            muteIndicator.className = 'mute-indicator';
            muteIndicator.innerHTML = `<i class="fas fa-microphone-slash text-white text-xs"></i>`;

            const statusOverlay = document.createElement('div');
            statusOverlay.className = 'connection-status-overlay';
            statusOverlay.textContent = 'Connecting...';
            
            container.appendChild(videoElement);
            container.appendChild(nameElement);
            container.appendChild(muteIndicator);
            if (id !== 'local') {
                container.appendChild(statusOverlay);
            }

            if (pinnedUserId) {
                const thumbnailBar = document.querySelector('.w-1/4, .w-1/5');
                if (thumbnailBar) {
                    container.classList.add('thumbnail');
                    thumbnailBar.appendChild(container);
                }
            } else {
                videoGrid.appendChild(container);
            }
            updateParticipantList();
        }

        function leaveCall() {
            if (ws) {
                ws.close();
                ws = null;
            }
            for (const peerId in peers) {
                if(peers[peerId]) {
                    peers[peerId].pc.close();
                }
            }
            Object.keys(peers).forEach(key => delete peers[key]);
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('video-grid').innerHTML = '<div class="text-center text-gray-400 col-span-full">Voc√™ saiu da chamada.</div>';
            document.getElementById('mic-btn').disabled = true;
            document.getElementById('video-btn').disabled = true;
            document.getElementById('screen-share-btn').disabled = true;
            document.getElementById('leave-btn').disabled = true;
            const statusIcon = document.getElementById('connection-status');
            statusIcon.classList.replace('text-green-500', 'text-red-500');
            statusIcon.title = 'Desconectado';
        }
        
        function toggleMic() { 
            if (!localStream || !localStream.getAudioTracks().length) {
                console.warn("Nenhuma faixa de √°udio local para silenciar.");
                return;
            }
            
            const audioTrack = localStream.getAudioTracks()[0];
            
            audioTrack.enabled = !audioTrack.enabled;
            const isMuted = !audioTrack.enabled; 
            
            const micBtn = document.getElementById('mic-btn');
            document.getElementById('mic-on-icon').classList.toggle('hidden', isMuted);
            document.getElementById('mic-off-icon').classList.toggle('hidden', !isMuted);
            micBtn.classList.toggle('bg-red-500', isMuted);
            micBtn.classList.toggle('bg-gray-700', !isMuted);

            document.getElementById('container-local').classList.toggle('muted', isMuted);

            for (const peerId in peers) {
                sendMessage({
                    type: 'mute_status',
                    muted: isMuted,
                    target: peerId
                });
            }
            updateParticipantList();
        }

        function toggleVideo() { 
            if (localStream && !isScreenSharing) { 
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    const isEnabled = videoTrack.enabled;
                    document.getElementById('video-on-icon').classList.toggle('hidden', !isEnabled);
                    document.getElementById('video-off-icon').classList.toggle('hidden', isEnabled);
                    document.getElementById('video-btn').classList.toggle('bg-red-500', !isEnabled);
                    document.getElementById('video-btn').classList.toggle('bg-gray-700', isEnabled);
                }
            } 
        }

        function renderDownloadsList() {
            const listContainer = document.getElementById('downloads-list');
            listContainer.innerHTML = '';

            if (receivedFiles.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-400">Nenhum ficheiro recebido ainda.</p>';
                return;
            }

            receivedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between bg-gray-700 p-2 rounded';
                fileItem.innerHTML = `
                    <span class="truncate">${file.name}</span>
                    <a href="${file.url}" download="${file.name}" class="ml-2 px-2 py-1 bg-green-500 rounded text-xs flex-shrink-0">Descarregar</a>
                `;
                listContainer.appendChild(fileItem);
            });
        }

        function toggleChatPanel() {
            const chatPanel = document.getElementById('chat-panel');
            chatPanel.classList.toggle('translate-x-full');

            if (!chatPanel.classList.contains('translate-x-full')) {
                document.getElementById('chat-btn').classList.remove('blinking-icon');
            }
        }

        function toggleParticipantsPanel() {
            const participantsPanel = document.getElementById('participants-panel');
            participantsPanel.classList.toggle('translate-x-full');
        }

        function updateParticipantList() {
            const listContainer = document.getElementById('participants-list');
            listContainer.innerHTML = ''; // Limpa a lista para a reconstruir

            // Adiciona o utilizador local
            const localAudioTrack = localStream?.getAudioTracks()[0];
            const isLocalMuted = localAudioTrack ? !localAudioTrack.enabled : false;
            const localItem = document.createElement('div');
            localItem.className = 'flex items-center justify-between';
            localItem.innerHTML = `
                <span>${localUserName} (Voc√™)</span>
                <div class="flex items-center space-x-2">
                    ${isHandRaised ? '<i class="fas fa-hand-paper text-yellow-400"></i>' : ''}
                    ${isLocalMuted ? '<i class="fas fa-microphone-slash text-red-500"></i>' : ''}
                </div>
            `;
            listContainer.appendChild(localItem);

            // Adiciona os outros participantes
            for (const peerId in peers) {
                const peer = peers[peerId];
                const peerItem = document.createElement('div');
                peerItem.className = 'flex items-center justify-between';
                peerItem.innerHTML = `
                    <span>${peer.name || `Remoto ${peerId.substring(0, 6)}`}</span>
                    <div class="flex items-center space-x-2">
                        ${peer.handRaised ? '<i class="fas fa-hand-paper text-yellow-400"></i>' : ''}
                        ${peer.muted ? '<i class="fas fa-microphone-slash text-red-500"></i>' : ''}
                    </div>
                `;
                listContainer.appendChild(peerItem);
            }
        }
        
        function toggleRaiseHand() {
            isHandRaised = !isHandRaised;
            const raiseHandText = document.getElementById('raise-hand-text');
            raiseHandText.innerText = isHandRaised ? 'Abaixar a M√£o' : 'Levantar a M√£o';
            
            for (const peerId in peers) {
                sendMessage({
                    type: 'raise_hand',
                    raised: isHandRaised,
                    target: peerId
                });
            }
            updateParticipantList();
        }

        // --- L√ìGICA DE INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            const lobbyView = document.getElementById('lobby-view');
            const entryModal = document.getElementById('entry-modal');
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');

            if (roomParam) {
                lobbyView.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Juntar-se √† Sala: ${roomParam}</h2>
                    <p class="text-gray-400 mb-6">Insira o seu nome para continuar.</p>
                    <form id="entry-form" class="space-y-4">
                        <input type="text" id="name-input" class="w-full bg-gray-700 text-white rounded-md p-3 text-center text-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="O seu nome" required>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors">Entrar na Chamada</button>
                    </form>
                `;
                document.getElementById('entry-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    localUserName = document.getElementById('name-input').value.trim();
                    if (localUserName) {
                        entryModal.classList.add('hidden');
                        start(roomParam);
                    }
                });
            } else {
                lobbyView.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Bem-vindo ao ConnectSphere</h2>
                    <p class="text-gray-400 mb-6">Crie uma nova sala de reuni√£o e convide outros.</p>
                    <button id="create-room-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors">Criar Nova Reuni√£o</button>
                `;
                document.getElementById('create-room-btn').addEventListener('click', () => {
                    const newRoomId = Math.random().toString(36).substring(2, 9);
                    window.location.search = `?room=${newRoomId}`;
                });
            }

            document.getElementById('leave-btn').addEventListener('click', leaveCall);
            document.getElementById('mic-btn').addEventListener('click', toggleMic);
            document.getElementById('video-btn').addEventListener('click', toggleVideo);
            document.getElementById('screen-share-btn').addEventListener('click', toggleScreenShare);
            
            document.getElementById('file-share-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });
            document.getElementById('file-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    sendFile(file);
                }
            });

            const downloadsBtn = document.getElementById('downloads-btn');
            const downloadsModal = document.getElementById('downloads-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');

            downloadsBtn.addEventListener('click', () => {
                renderDownloadsList();
                downloadsModal.classList.remove('hidden');
                downloadsModal.classList.add('flex');
                downloadsBtn.classList.remove('blinking-icon');
            });

            closeModalBtn.addEventListener('click', () => {
                downloadsModal.classList.add('hidden');
                downloadsModal.classList.remove('flex');
            });

            downloadsModal.addEventListener('click', (event) => {
                if (event.target === downloadsModal) { 
                    downloadsModal.classList.add('hidden');
                    downloadsModal.classList.remove('flex');
                }
            });

            const chatBtn = document.getElementById('chat-btn');
            const closeChatBtn = document.getElementById('close-chat-btn');
            const chatForm = document.getElementById('chat-form');

            chatBtn.addEventListener('click', toggleChatPanel);
            closeChatBtn.addEventListener('click', toggleChatPanel);
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendChatMessage();
            });

            const participantsBtn = document.getElementById('participants-btn');
            const closeParticipantsBtn = document.getElementById('close-participants-btn');
            const raiseHandBtn = document.getElementById('raise-hand-btn');

            participantsBtn.addEventListener('click', () => {
                updateParticipantList();
                toggleParticipantsPanel();
            });
            closeParticipantsBtn.addEventListener('click', toggleParticipantsPanel);
            raiseHandBtn.addEventListener('click', toggleRaiseHand);

            document.querySelectorAll('.emoji-reaction').forEach(emojiBtn => {
                emojiBtn.addEventListener('click', (e) => {
                    sendEmojiReaction(e.target.innerText);
                });
            });

            document.getElementById('copy-link-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Link do convite copiado para a √°rea de transfer√™ncia!');
                });
            });

            document.getElementById('whiteboard-btn').addEventListener('click', () => {
                toggleWhiteboardPanel();
            });

            document.getElementById('close-whiteboard-btn').addEventListener('click', () => {
                toggleWhiteboardPanel();
            });
            
            document.getElementById('clear-whiteboard-btn').addEventListener('click', () => {
                const data = { type: 'clear' };
                handleWhiteboardDraw(data); // Limpa localmente
                for (const peerId in peers) {
                    sendMessage({ type: 'whiteboard', data: data, target: peerId });
                }
            });

            document.getElementById('color-picker').addEventListener('change', (e) => {
                drawColor = e.target.value;
            });
        });

        function setWhiteboardState(isOpen) {
            const whiteboardPanel = document.getElementById('whiteboard-panel');
            const isHidden = whiteboardPanel.classList.contains('hidden');

            if (isOpen && isHidden) {
                whiteboardPanel.classList.remove('hidden');
                whiteboardPanel.classList.add('flex');
                initWhiteboard();
            } else if (!isOpen && !isHidden) {
                whiteboardPanel.classList.add('hidden');
                whiteboardPanel.classList.remove('flex');
            }
        }

        function toggleWhiteboardPanel() {
            const whiteboardPanel = document.getElementById('whiteboard-panel');
            const isOpen = whiteboardPanel.classList.contains('hidden');
            setWhiteboardState(isOpen);

            for (const peerId in peers) {
                sendMessage({
                    type: 'whiteboard_state',
                    state: isOpen ? 'open' : 'closed',
                    target: peerId
                });
            }
        }

        function initWhiteboard() {
            const canvas = document.getElementById('whiteboard-canvas');
            if (canvas.dataset.initialized) return;
            canvas.dataset.initialized = true;

            whiteboardCtx = canvas.getContext('2d');
            
            const resizeCanvas = () => {
                const parent = canvas.parentElement;
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight;
                whiteboardCtx.lineJoin = 'round';
                whiteboardCtx.lineCap = 'round';
                whiteboardCtx.lineWidth = 5;
            };

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: (clientX - rect.left) * scaleX,
                    y: (clientY - rect.top) * scaleY
                };
            };

            const startDrawing = (e) => {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                [lastX, lastY] = [pos.x, pos.y];
            };

            const draw = (e) => {
                e.preventDefault();
                if (!isDrawing) return;
                const pos = getPos(e);
                const drawData = {
                    type: 'draw',
                    from: { x: lastX, y: lastY },
                    to: { x: pos.x, y: pos.y },
                    color: drawColor
                };
                handleWhiteboardDraw(drawData);
                for (const peerId in peers) {
                    sendMessage({ type: 'whiteboard', data: drawData, target: peerId });
                }
                [lastX, lastY] = [pos.x, pos.y];
            };

            const stopDrawing = () => {
                isDrawing = false;
            };

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function handleWhiteboardDraw(data) {
            if (!whiteboardCtx) {
                setWhiteboardState(true);
            }
            if (data.type === 'draw') {
                whiteboardCtx.beginPath();
                whiteboardCtx.strokeStyle = data.color;
                whiteboardCtx.moveTo(data.from.x, data.from.y);
                whiteboardCtx.lineTo(data.to.x, data.to.y);
                whiteboardCtx.stroke();
            } else if (data.type === 'clear') {
                whiteboardCtx.clearRect(0, 0, whiteboardCtx.canvas.width, whiteboardCtx.canvas.height);
            }
        }

    </script>
</body>
</html>
